---
output: 
  pdf_document:
   fig_caption: false
   includes: 
     in_header: factsheet_template_header.tex
geometry: margin=0.75cm
fontsize: 11pt  
df_print: kable
params: 
  draft: FALSE
  pages: 2
  aq_num: 0
---


```{r, include = FALSE}
# Set some knitr options 
# - We never want to show code, so echo = FALSE
knitr::opts_chunk$set(echo = FALSE)
```

```{r data}
# Regarding document type
p1 <- "factsheet_template_p1.Rmd"
p2 <- "factsheet_template_p2.Rmd"

aq_num <- as.numeric(params$aq_num)
```




```{r setup, include = FALSE}
library(readr)
library(readxl)
library(stringr)
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)

aq_num_ch <- sprintf("%04d", aq_num)

aquifer <- read_csv("../out/aquifer_table.csv") %>%
  filter(AQUIFER_ID %in% aq_num) %>%
  mutate_all(funs(str_replace_all(., c("\\&" = "\\\\&", "\\#" = "\\\\#")))) # Escape & symbols

title <- aquifer$AQUIFER_NAME
if(title == "" | title == aq_num_ch | title == aq_num | is.na(title)) {
  #title <- "No local name currently assigned"
  title <- ""
}
ow <- read_csv("../out/aquifer_ow.csv") %>%
  filter(AQUIFER_ID %in% aq_num) %>%
  mutate(OW_CH = sprintf("%04d", OW),
         format = case_when(OBSERVATION_WELL_STATUS == "Active" ~ paste0("\\textbf{", OW, "}"),
                            TRUE ~ as.character(OW)))

# Add hyperlink to description. NOTE: Every '\' in a link requires 4 \ in order to make sure it is properly escaped. '_' requires 2 \. Every latex command (e.g., \textbf) requires 2 \ as well.
desc <- paste0("\\link[grey]{\\\\\\\\appfiles.bcgov\\\\aquiferdata\\_prod}{\\textbf{Aquifer Description:}}\\\\",
               str_replace(aquifer$DESCRIPTION, ".$", ""), # Replace the trailing period with nothing
               " (subtype = ", aquifer$AQUIFER_SUBTYPE_CODE, ").")

# Note that ~ (below) means a non-breaking space, which forces the tables to use a different spot to wrap the text
aquifer <- aquifer %>%
  mutate(OW = case_when(nrow(ow) > 0 ~ paste0(ow$format, collapse = ", "),
                        TRUE ~ "None")) %>%
  select(`Region` = REGION, 
         `Water District` = WATER_DISTRICT, 
         `Aquifer Area` = SIZE_KM2,
         `No. Wells Correlated to Aquifer` = REPORTED_NUMBER_OF_WELLS,
         `Vulnerability to Contamination` = VULNERABILITY,
         `Productivity` = PRODUCTIVITY,
         `Aquifer Classification` = AQUIFER_CLASSIFICATION,
         `Hydraulic~Connectivity (based~on~broad~regional~assessment)` = HYDRAULIC_CONNECTIVITY,
         `Aquifer Stress Index` = AQUIFER_PUMPING_STRESS_INDEX,
         `Number of Water Licences Issued~to~Wells` = NUMBER_OF_LICENCES,
         `Observation Wells (\\footnotesize{\\textbf{Active},~Abandoned})` = OW) %>%
  mutate_if(is.na, ~ "Unknown") %>%
  mutate(`Aquifer Area` = replace(`Aquifer Area`, 
                                  `Aquifer Area` != "Unknown",
                                  paste(`Aquifer Area`, "km\\textsuperscript{2}")))

# Add hyperlinks
aquifer <- aquifer %>%
  rename(`\\link{http://www.bclaws.ca/civix/document/id/complete/statreg/38_2016}{Water District}` = `Water District`,
         `\\link{http://www.env.gov.bc.ca/wsd/plan_protect_sustain/groundwater/aquifers/reports/aquifer_maps.pdf\\#page=16}{Vulnerability to Contamination}` = `Vulnerability to Contamination`,
         `\\link{http://www.env.gov.bc.ca/wsd/plan_protect_sustain/groundwater/aquifers/reports/aquifer_maps.pdf\\#page=19}{Productivity}` = `Productivity`,
         `\\link{http://www.env.gov.bc.ca/wsd/plan_protect_sustain/groundwater/aquifers/reports/aquifer_maps.pdf\\#page=15}{Aquifer Classification}` = `Aquifer Classification`,
         `\\link{http://a100.gov.bc.ca/appsdata/acat/documents/r50832/HydraulicConnectMW3_1474311684426_4310694949.pdf}{Hydraulic~Connectivity (based~on~broad~regional~assessment)}` = `Hydraulic~Connectivity (based~on~broad~regional~assessment)`,
         `\\link{http://governmentofbc.maps.arcgis.com/home/webmap/viewer.html?webmap=6c137fb01a364ee699440a28619e45c2}{Aquifer Stress Index}` = `Aquifer Stress Index`)

# Transform for factsheet
aquifer <- aquifer %>%
  gather(Name, Data)

```


```{r figures, include = FALSE}
# Create a list of all the figures to include
figures_p1 <- list()

# Page 1
figures_p1$map <- list.files("../figures/maps/", pattern = paste0("Aquifer_Map_", aq_num_ch, ".pdf"), full.names = TRUE)
figures_p1$water_depth <- list.files("../out/boxplots/", pattern = paste0("water_depth_", aq_num_ch, ".jpg"), full.names = TRUE)
figures_p1$well_yield <- list.files("../out/boxplots/", pattern = paste0("yield_", aq_num_ch, ".jpg"), full.names = TRUE)
figures_p1$well_depth <- list.files("../out/boxplots/", pattern = paste0("well_depth_", aq_num_ch, ".jpg"), full.names = TRUE)

# Replace empty figures with NA plots
if(length(figures_p1$map) == 0) figures_p1$map <- "../figures/maps/NA.png"
if(length(figures_p1$water_depth) == 0) figures_p1$water_depth <- "../out/boxplots/water_depth_NA.jpg"
if(length(figures_p1$well_yield) == 0) figures_p1$well_yield <- "../out/boxplots/yield_NA.jpg"
if(length(figures_p1$well_depth) == 0) figures_p1$well_depth <- "../out/boxplots/well_depth_NA.jpg"

# Page 2
# Only active wells
ow <- filter(ow, OBSERVATION_WELL_STATUS == "Active") 

if(nrow(ow) > 0) {
  figures_p2 <- tibble(a = rep(aq_num_ch, 3*nrow(ow)), ow = rep(ow$OW_CH, 3), 
                       type = sort(rep(c("combo", "trend", "piper"), length(ow)/3))) %>%
    mutate(fig = case_when(type == "combo" ~ paste0("../out/gwl/Combo_", a, "_OW", ow, ".png"),
                           type == "trend" ~ paste0("../out/trends/trends_", a, "_OW", ow, ".png"),
                           type == "piper" ~ paste0("../figures/piperplots/Piperplot_", a, "_OW", ow, ".jpg")),
           exists = file.exists(fig),
           fig = replace(fig, !exists, paste0("../figures/na/figure_missing_", type[!exists], ".png"))) %>%
    group_by(ow) %>%
    mutate(missing = sum(!exists)) %>%
    filter(missing != 3) %>%
    select(-exists, -missing)
  
  # Omit well if missing all figures
  for(o in unique(figures_p2$ow)) {
    if(all(str_detect(figures_p2$fig[figures_p2$ow == o], "figure_missing"))) {
      figures_p2 <- filter(figures_p2, ow != o)
    }
  }
  
  # Get Piper text for each obs well and add link
  piper_text <- read_excel("../data/piper_text.xlsx", sheet = 1) %>%
    mutate(Hydrogeochemistry = paste0(Hydrogeochemistry,
                                     " \\link[grey]{https://a100.gov.bc.ca/pub/ems/mainmenu.do?",
                                     "userAction=monitoringLocationsCriteria&bean.p_mon_locn_id=", EMS_ID, 
                                     "}{For EMS water chemistry data, EMSID ", EMS_ID, "}."))
  
  
} else {
  figures_p2 <- tibble()
}
```
  
  
```{r create_page1, results = "asis"}
cat(knit_child(p1))
```


```{r create_page2s, eval = nrow(figures_p2) > 0 & params$pages == 2, results = "asis"}
# Get obs wells from figure names
obs_wells <- sort(unique(figures_p2$ow))


if(length(obs_wells) > 0) {
  wells <- read.csv("../out/wells_table.csv", stringsAsFactors = FALSE) %>%
    filter(OW %in% as.numeric(obs_wells))
}

out <- NULL
for (o in obs_wells) {
  f <- filter(figures_p2, ow == o) %>%
    spread(type, fig)
  
  # Run through p2 template
  ow <- as.numeric(as.numeric(str_extract(o, "[0-9]{4}")))
  
  # Get piper text
  p_text <- piper_text$Hydrogeochemistry[piper_text$obs_well == ow]
  
  cat("\\newpage")
  cat(knit_child(p2))
}
```
